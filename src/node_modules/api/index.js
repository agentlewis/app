var express = require('express')
var FsDb = require('fs-db')
var pull = require('pull-stream')
var sendJson = require('send-data/json')

module.exports = createApi

function createApi (config) {
  var api = express()

  var db = FsDb({
    location: config.data.location
  })

  var graph = undefined
  var queue = []

  pull(
    db.createReadStream(),
    pull.collect(function (err, arr) {
      if (err) { throw err }

      graph = {
        "@context": {},
        "@graph": arr
      }

      queue.forEach(function (cb) { cb() })
      queue = []
    })
  )

  api.get('/', function (req, res) {
    if (graph == null) {
      queue.push(sendGraph.bind(null, req, res))
    } else {
      sendGraph(req, res)
    }
  })

  function sendGraph (req, res) {
    sendJson(req, res, graph)
  }

  return api
}
