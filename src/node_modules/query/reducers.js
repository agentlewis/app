import testState from 'state'
import { agentsById } from 'agent/getters'
import { queryTypesByAgentId } from 'query-type/getters'
import filter from 'lodash.filter'
import map from 'lodash.map'
import omit from 'lodash.omit'
import some from 'lodash.some'
const debug = require('debug')('query:reducers')

// omit
function dedupPersonQueryTypes (queryTypes) {
  return function (queryType) {
    return some(queryTypes, qt => {
      return qt.relationshipType === queryType.relationshipType &&
        qt.direction === 'source' && queryType.direction === 'target'
    })
  }
}

function reduceGroupQueryTypes (queryTypes) {
  return function (queryType, key) {
    return key === 'includes/group/target'
      || 'is-member-of/group/target'
      || (key === 'is-member-of/person/target' &&
        !queryTypes['is-member-of/group/target'])
  }
}

function queryReducer (state = testState, action) {
  const agentId = action.payload
  console.log('queryReducer', state, action)
  if (action.type === 'AGENT_GRAPH' && state.graph.queries.length === 0) {
    // queries empty -> default queries
    let agent = agentsById(state)[agentId]
    let queryTypes = queryTypesByAgentId(state)[agentId]
    debug('agent', agent, queryTypesByAgentId(state))

    if (agent.type === 'person') {
      debug('Person', queryTypes)
      // debugger
      return queryTypes
      // return  omit(queryTypes, dedupPersonQueryTypes(queryTypes))
    } else {
      debug('Group', queryTypes)
      // debugger

      return filter(queryTypes, reduceGroupQueryTypes(queryTypes))
    }
  }

  return state.graph.queries
}

export default queryReducer
