
var debug = require('debug')('graph:index')

const Node = require('node-ui')
const EdgeGroup = require('edge-group')


import { loadAgentGraph, agentGraph } from './action-creators'
import R from 'ramda'
import svg from 'virtual-dom/virtual-hyperscript/svg'
import h from 'virtual-dom/virtual-hyperscript' 
import component from 'virtual-component'
import element from 'virtex-element'
import { getNodes, getContextAgentId, getShouldUpdate } from 'graph/getters'




function center(vector2d, width, height) {
  return {
    x: vector2d.x + width / 2,
    y: vector2d.y + height / 2
  }
}



function render ({props}) {
  debug('state', props)
  const nodes = getNodes(props)

  debug('render', nodes)
  return element(
    'div',
    {
      class: 'graph',
      style: {
        width: window.screen.width + 'px',
        height: window.screen.height + 'px'
      }
      // style: { cursor: this.state.dragging ? 'move' : 'auto' },
      // onMouseDown: this.handleMouseDown,
      // onMouseMove: this.handleMouseMove,
      // onMouseUp: this.handleMouseUp,
      // onWheel: this.handleWheel
    },
    [
      element('div', { id: 'transform-layer' }, [
         nodes
          ? R.map(node => element(Node, { ...node, height: 50, width: 50}), nodes)
          : null
      ])
     // EdgeGroup({ ...props })
    ]
  )
}

function afterUpdate (prev, next) {
  debug('afterUpdate', prev, next)
  
  const { route, initialized } = next.props
  const nextAgentId = getContextAgentId(next.props)
  debug('route etc', route, nextAgentId)
  if (initialized && route !== nextAgentId) {
    return loadAgentGraph(route)
  }
}

function shouldUpdate (prev, next) {
  debug('shouldUpdate', getShouldUpdate(next.props))
  
  if (getShouldUpdate(next.props)) {
    return true
  } else {
    return false
  }
}




const Graph = {
//  shouldUpdate,
  afterUpdate,
  render
}

//module.exports = (props, children) => component(Graph, props, children)
module.exports = Graph
// module.exports = React.createClass({
//
//   propTypes: {
//     dispatch: React.PropTypes.func,
//     route: React.PropTypes.object
//   },
//
//   componentWillMount: function () {
//     const { dispatch, route } = this.props
//     debug('componentWillMount', dispatch, loadAgentGraph)
//
//     dispatch(loadAgentGraph(route.context))
//
//   },
//
//   componentWillReceiveProps: function (nextProps) {
//     const { dispatch, route } = this.props
//
//     if (nextProps.route.context !== route.context) { // TODO
//       console.log(nextProps.route)
//       dispatch(loadAgentGraph(route.context))
//     }
//   },
//
//   renderNodes: function (nodes) {
//     if (!nodes) { return [] }
//     return map(nodes, node => {
//       // let vector2d = center(
//       //   node,
//       //   window.screen.width,
//       //   window.screen.height
//       // )
//
//       return React.createElement(Node, {
//         ...node,
//         width: 40,
//         height: 40
//       })
//     })
//   },
//
//   render: function () {
//     const nodes = this.renderNodes(this.props.graph.nodes)
//     debug('nodes', nodes)
//     // debugger
//
//     return (
//       r.svg(
//         {
//           className: 'graph-svg',
//           width: window.screen.width,
//           height: window.screen.height,
//           // style: { cursor: this.state.dragging ? 'move' : 'auto' },
//           // onMouseDown: this.handleMouseDown,
//           // onMouseMove: this.handleMouseMove,
//           // onMouseUp: this.handleMouseUp,
//           // onWheel: this.handleWheel
//         },
//         [
//           r.g(
//             {
//               id: 'transform-layer',
//               // transform: transform(this.props.vector)
//             },
//             [
//               // r.g({className: 'halo-group'}, [
//               //   r(EdgeGroup,
//               //       {
//               //         queries: this.props.queries,
//               //         nodes: nodes,
//               //         edges: edges,
//               //         model: this.props.model,
//               //         route: this.props.route
//               //       }
//               //     )
//               //   ]
//               // ),
//             r.g({className: 'node-group'}, nodes)
//           ]
//         )]
//       )
//     )
//   }
// })
