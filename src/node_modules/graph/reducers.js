const createGraph = require('ngraph.graph')
const updateGraph = require('./update-graph')
const iterateLayout = require('./iterate-layout')
const Layout = require('ngraph.forcelayout')
const testState = require('state')
const debug = require('debug')('graph:reducers')
const each = require('lodash.foreach')
const ITERATIONS = 50


import { relationshipsByAgentId } from 'relationship/getters'
import { agentsById } from 'agent/getters'
import queryReducer from 'query/reducers'
import some from 'lodash.some'

console.log('testState', testState)

function matchQuery(relationship, queries, agentId) {
  return some(queries, query => {
    return relationship.type === query.relationshipType &&
      relationship[query.direction] === agentId
  })
}

const Graph = (state, action, queries) => {
  let graph = createGraph()
  let agents = agentsById(state)
  graph.beginUpdate()

  each(relationshipsByAgentId(state)[action.payload], relationship => {
    if (matchQuery(relationship, queries, action.payload)) {
      graph.addLink(relationship.source, relationship.target, relationship)
    }
  })

  graph.forEachNode(node => {
    graph.addNode(node.id, agents[node.id])
  })

  graph.endUpdate()
  return graph
}

export const graphReducer = (state = testState, action) => {
  if (action.type === 'AGENT_GRAPH') {
    let queries = queryReducer(state, action)
    let graph = Graph(state, action, queries)
    let layout = Layout(graph, { springLength: 60 })

    for (let i=0; i<ITERATIONS; i++) {
      layout.step()
    }

    return {
      queries,
      graph,
      layout
    }



  } else {
    return state.graph
  }

}
