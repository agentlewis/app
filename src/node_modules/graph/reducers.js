const createGraph = require('ngraph.graph')
const updateGraph = require('./update-graph')
const iterateLayout = require('./iterate-layout')
const mapValues = require('lodash.mapvalues')
const Layout = require('ngraph.forcelayout')
const testState = require('state')
const debug = require('debug')('graph:reducers')
const each = require('lodash.foreach')
const extend = require('xtend')
const ITERATIONS = 50


import { relationshipsByAgentId } from 'relationship/getters'
import { agentsById } from 'agent/getters'
import queryReducer from 'query/reducers'
import some from 'lodash.some'
import Cola from 'webcola'
// import Adaptor from './webcola-adaptor'

console.log('testState', testState)

function matchQuery(relationship, queries, agentId) {
  return some(queries, query => {
    return relationship.type === query.relationshipType &&
      relationship[query.direction] === agentId
  })
}

const Graph = (state, action, queries) => {
  let graph = createGraph()
  let agents = agentsById(state)
  let nodeToIndex = {}
  let nodes = []
  let links = []
  let layout = new Cola.Layout()
  // cola.Layout.prototype.links(mapValues)

  graph.beginUpdate()

  each(relationshipsByAgentId(state)[action.payload], relationship => {
    if (matchQuery(relationship, queries, action.payload)) {
      ;['source', 'target'].forEach(direction => {
        if (!nodeToIndex[relationship[direction]]) {
          nodeToIndex[relationship[direction]] = nodes.length
          nodes.push(agents[relationship[direction]])
        }
      })
      links.push(extend(relationship, {
        source: nodeToIndex[relationship.source],
        target: nodeToIndex[relationship.target]
      }))
      graph.addLink(relationship.source, relationship.target, relationship)
    }
  })

  layout.nodes(nodes)
  layout.links(links)


  layout.start()

  let n = layout.nodes()
  debug(n)


    debug('nodes', nodes)
    debug('links', links)
    debug('nodeToIndex', nodeToIndex)

  graph.forEachNode(node => {
    graph.addNode(node.id, agents[node.id])
  })

  graph.endUpdate()
  return graph
}

export const graphReducer = (state = testState, action) => {
  if (action.type === 'AGENT_GRAPH') {
    let queries = queryReducer(state, action)
    debug('queries', queries)
    let graph = Graph(state, action, queries)
    let layout = Layout(graph, { springLength: 120, gravity: -1.5 })

    for (let i=0; i<ITERATIONS; i++) {
      layout.step()
    }

    return {
      queries,
      graph,
      layout
    }



  } else {
    return state.graph
  }

}
