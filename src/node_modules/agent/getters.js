'use strict';

const rolesByAgent = [
  ['agents'], 
  ['roles'],
  function (agents, roles) {
    return agents.map(function (agent, agentId) {
      return roles.filter(function (role) {
        return role.agent === agentId
      })
    })
  }
]

const relationshipsByAgent = [
  ['agents'],
  rolesByAgent,
  ['relationships'],
  function (agents, rolsByAgent) {
    return agents.map(function (agent, agentId) {
      return rolsByAgent.get(agent)
      .map(function (role) {
        return relationships.get(role.relationship)
      })
      .filter(function (relationship) {
        return relationship
      })
    })
  }
]

var groupsByAgent = [
  ['agents'],
  relationshipsByAgent,
  ['relationshipTypes'],
  require('relationship').getters.rolesByRelationship,
  function (agents, relsByAgent, rolesByRelationship) {
    return agents.map(function (agent, agentId) {
      return relsByAgent.get(agent)
      .filter(function (rel) {
        return rel.type === 'membership'
      })
      .map(function (rel) {
        return rolesByRelationship.get(rel)
        .filter(function (role) {
          return role.type === 'group'
        })
        .map(function (role) {
          return agent.get(role.agent)
        })
      })
    })
  }
]

module.exports = {
  rolesByAgent,
  relationshipsByAgent,
  groupsByAgent
}
