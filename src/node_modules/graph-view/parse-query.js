var dot = require('dot-object')
var debug = require('debug')('parse-query')

module.exports = function (query, model) {
  var options = []
  var q = query.q || []
  var modelId = model ? model.id : ''

  debug('query', query, model)

  var activeTypesById = q.reduce(function (memo, q) {
    var pair = q.tgt || q.src || modelId
    var src = q.src || modelId
    var tgt = q.tgt || ''

    if (q.role) {
      debug('query has role', q.role, model.id)
      memo[q.role + '.pair.' + pair] = q

      if (q.tgt) { memo[q.role + '.targets.' + tgt] = q }
      if (q.src) { memo[q.role + '.sources.' + src] = q }
      if (q.ctx) { memo[q.role +'.context.'+ q.ctx] = q }
    }
    // if (q.link) {
    //   if (q.tgt) { memo[q.link +'.target.'+ q.tgt] = q }
    //   if (q.src) { memo[q.link +'.source.'+ q.src] = q }
    //   if (q.ctx) { memo[q.link +'.context.'+ q.ctx] = q }
    // }
    // if (q.at) {
    //   if (q.tgt) { memo[q.at +'.target.'+ q.tgt] = q }
    //   if (q.src) { memo[q.at +'.source.'+ q.src] = q }
    //   if (q.ctx) { memo[q.at +'.context.'+ q.ctx] = q }
    // }
    // if (q.tgt) {
    //   if (q.role) { memo['targets.roles.' + q.role] = q }
    //   if (q.link) { memo['targets.links.' + q.link] = q }
    // }


    return memo
  }, {})

  dot.object(activeTypesById)

  return activeTypesById

}
