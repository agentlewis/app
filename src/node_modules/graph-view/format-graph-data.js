var includes = require('lodash.includes')
var reduce = require('lodash.reduce')
var debug = require('debug')('graph-view:make-links')

function makeLink (subj, relationship, obj) {
  return {
    source: subj.index,
    target: obj.index,
    model: relationship
  }
}

module.exports = function (linkTypes, graph) {
  var nodes = []
  var links = []

  debug('formatGraphData(', linkTypes, graph)

  var activeLinkTypeIds = reduce(linkTypes, function (acc, linkType, linkTypeId) {
    if (linkType.active) {
      acc.push(linkTypeId)
    }
  }, [])

  var idToIndex = {}

  graph.forEachNode(function (node) {
    nodes.push(node.data)
    idToIndex[node.id] = nodes.length - 1
  })

  graph.forEachLink(function (link) {
    if (includes(activeLinkTypeIds, link.data.type.getId())) {
      var fromIndex = idToIndex[link.fromId]
      var toIndex = idToIndex[link.toId]
      links.push({
        source: fromIndex,
        target: toIndex,
        model: link.data
      })
    }
  })

  debug("formatGraphData() ->", nodes, links)
  return [nodes, links]
}
