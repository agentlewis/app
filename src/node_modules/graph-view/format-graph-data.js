var keys = require('lodash.keys')
var debug = require('debug')('graph-view:formatGraphData')

var colors = require('./colors')

module.exports = function (linkTypes, graph) {
  var nodes = []
  var links = []

  debug('linkTypes, graph', linkTypes, graph)

  var idToIndex = {}

  graph.forEachNode(function (node) {
    nodes.push({
      id: node.id,
      model: node.data
    })
    idToIndex[node.id] = nodes.length - 1
  })

  graph.forEachLink(function (link) {
    var linkTypeId = link.data.type.getId()
    var linkType = linkTypes[linkTypeId]

    if (!linkType) {
      linkType = linkTypes[linkTypeId] = {
        active: false,
        color: colors[keys(linkTypes).length],
        model: link.data.type
      }
    }

    if (linkType.active) {
      var fromIndex = idToIndex[link.fromId]
      var toIndex = idToIndex[link.toId]
      links.push({
        id: link.id,
        source: fromIndex,
        target: toIndex,
        model: link.data,
        color: linkType.color
      })
    }
  })

  debug('formatGraphData() ->', nodes, links)
  return [nodes, links]
}
