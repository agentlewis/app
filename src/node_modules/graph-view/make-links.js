var _ = require('lodash');

function makeLink (subj, relationship, obj) {
	return {
		source: subj.index,
		target: obj.index,
		model: relationship
	};
}

module.exports = function (predicates, edgeObj, nodes) {
	var links = [];

	for (var i=0;i<predicates.length;i++) {
		var predicate 	= predicates[i];
		var subjectIds 	= edgeObj[predicate];
		
		if (subjectIds) {
			Object.keys(subjectIds).forEach(function (subjId) {
				var subject 	= _.find(nodes, function (node) {  if (node._values) return node._values["@id"] === subjId; });
				var objectIds = edgeObj[predicate][subjId];
				
				for (var j=0;j<objectIds.length;j++) {
					var relationship;
					var objId 				= objectIds[j];
					var object 				= _.find(nodes, function (node) { if (node._values) return node._values["@id"] === objId; });
					
					if (object) {
						relationship = _.find(object.relationships.models, function (rel) {
							if (rel._values) {
								return (
									rel._values.is === subjId && 
									rel._values.relationshipType === predicate
								);
							}
						});
						
						links.push(makeLink(subject, relationship, object));
					}
				}
			});				
		}
	}

	return links;
};