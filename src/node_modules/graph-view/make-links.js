var _ = require('lodash')
var debug = require('debug')('graph-view:make-links')

function makeLink (subj, relationship, obj) {
  return {
    source: subj.index,
    target: obj.index,
    model: relationship
  }
}

module.exports = function (predicates, edgeObj, nodes) {
  var links = []
  debug('edgeObj', edgeObj, predicates, nodes )

  _.each(predicates, function (predicate) {
    var subjectIds  = edgeObj[predicate]
      
    if (subjectIds) {
      Object.keys(subjectIds).forEach(function (subjId) {
        var subject   = _.find(nodes, function (node) {  return node["@id"] === subjId })
        var objectIds = edgeObj[predicate][subjId]
        
        _.each(objectIds, function (objId) {
          var object = _.find(nodes, function (node) { return node["@id"] === objId })
          
          if (object) {
            var relationship = _.find(subject.relationships.models, function (rel) {
              debug('rel', rel)
              return (
                rel.is['@id'] === subjId && 
                rel.has['@id'] === objId &&
                rel.relationshipType['@id'] === predicate
              )

            })
            
            if (relationship) links.push(makeLink(subject, relationship, object))
          }
        })
      })       
    }
  })

  return links
}