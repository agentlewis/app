var _ = require('lodash');
var debug = require('debug')('graph-view:make-links')

function makeLink (subj, relationship, obj) {
  return {
    source: subj.index,
    target: obj.index,
    model: relationship
  };
}

module.exports = function (predicates, edgeObj, nodes) {
  var links = [];
  debug('edgeObj', edgeObj, predicates)

  _.each(predicates, function (predicate) {
    var subjectIds  = edgeObj[predicate];
    
    if (subjectIds) {
      Object.keys(subjectIds).forEach(function (subjId) {
        var subject   = _.find(nodes, function (node) {  if (node._values) return node._values["@id"] === subjId; });
        var objectIds = edgeObj[predicate][subjId];
        
        _.each(objectIds, function (objId) {
          var object        = _.find(nodes, function (node) { if (node._values) return node._values["@id"] === objId; });
          
          if (object) {
            var relationship = _.find(subject.relationships.models, function (rel) {
              if (rel._values) {
                return (
                  rel._values.is === subjId && 
                  rel._values.has === objId &&
                  rel._values.relationshipType === predicate
                );
              }
            });
            
            if (relationship) links.push(makeLink(subject, relationship, object));
          }
        });
      });       
    }
  });

  return links;
};