#!/usr/bin/env node

var pm = require('pm2')

pm.connect(function (err) {
  if (err) { throw err }
  pm.start(require('../processes'), killOnError)
})

pm.launchBus(function (err, bus) {
  killOnError(err)

  bus.on('log:out', function (type, data) {
    console.log(type, data)
  })
})

process.on('SIGINT', function() {
  kill()
})

function kill () {
  pm.killDaemon(function (err) {
    logError(err)
    pm.disconnect()
    pm.disconnectBus()
    process.exit(1)
  })
}

function logError (err) {
  if (err) { console.error(err) }
}

function killOnError (err) {
  logError(err)
  if (err) { kill(logError) }
}
