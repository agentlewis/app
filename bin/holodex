#!/usr/bin/env node

var pm = require('pm2')
var Log = require('pm2/lib/Log')

pm.connect(function (err) {
  if (err) { throw err }
  pm.start(require('../processes'), killOnError)
})

Log.stream('all', true, 'YYYY-MM-DD-HH:mm:ss', false)

process.on('SIGINT', function() {
  kill()
})

function kill () {
  pm.killDaemon(function (err) {
    logError(err)
    pm.disconnectBus(function (err) {
      logError(err)
      process.exit(1)
    })
  })
}

function logError (err) {
  if (err) { console.error(err) }
}

function killOnError (err) {
  logError(err)
  if (err) { kill(logError) }
}
